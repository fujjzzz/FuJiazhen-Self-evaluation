本周阅读**Database-System-Concepts-7th-Edition**:PART FIVE STORAGE MANAGEMENT AND INDEXING,知识点总结如下：  
**Chapter 12 Physical Storage Systems**(p559-584)  
>日期：5.6

# 第12章 物理存储系统（Physical Storage Systems）
## 12.1 物理存储介质概述（Overview of Physical Storage Media）
计算机系统中存在多种数据存储类型，按数据访问速度、单位数据购买成本和介质可靠性分类。主要存储介质包括：
- **高速缓存（Cache）**：最快且最昂贵的存储形式，容量相对小，由计算机系统硬件管理。数据库设计查询处理数据结构和算法时会考虑其影响。
- **主存（Main memory）**：用于存储可操作数据的存储介质，通用机器指令在主存上操作。个人计算机主存可能包含几十GB数据，大型服务器系统可达几百到几千GB。断电或系统崩溃时数据丢失，具有易失性。 
- **闪存（Flash memory）**：非易失性存储，断电数据仍保留。每字节成本低于主存但高于磁盘。广泛用于相机、手机等设备，也用于USB闪存驱动器。固态硬盘（SSD）内部使用闪存，提供类似磁盘接口。 
- **磁盘存储（Magnetic-disk storage）**：长期在线存储数据的主要介质，即硬盘驱动器（HDD），非易失性。访问数据时需先将数据从磁盘移到主存，操作后修改的数据需写回磁盘。2018年，磁盘容量500GB - 14TB，1TB磁盘约50美元 ，8TB约150美元，比SSD便宜但性能低。 
- **光盘存储（Optical storage）**：如数字视频光盘（DVD），用激光读写数据。蓝光DVD格式容量27GB - 128GB 。主要用于存储视频数据，也可存储任何数字数据，但访问时间长，不适合存储活跃数据库数据。部分DVD是只读或一次写入多次读取（WORM）。光盘自动换片机系统可自动加载光盘。 
- **磁带存储（Tape storage）**：主要用于备份和存档数据，存档数据因法律等原因需长期安全存储。磁带便宜，可安全存储多年，但访问数据慢，是顺序访问存储。磁带容量大（1 - 12TB ），磁带驱动器贵但单盘磁带比同容量磁盘便宜。磁带库用于自动存储和检索大量磁带。

存储介质可按速度和成本分层：
- **一级存储（Primary storage）**：最快，如高速缓存和主存。
- **二级存储（Secondary storage/Online storage）**：如闪存和磁盘。
- **三级存储（Tertiary storage/Offline storage）**：如磁带和光盘自动换片机系统。

主存及以上存储具有易失性，闪存及以下存储具有非易失性。 

## 12.2 存储接口（Storage Interfaces）
- **磁盘接口**：磁盘（磁性磁盘和基于闪存的固态硬盘）通过高速互连连接到计算机系统，支持串行ATA（SATA）接口或串行连接SCSI（SAS）接口 ，SAS接口一般用于服务器。SATA-3版标称支持6Gbps ，数据传输速度可达600MB/s ，SAS 3版支持12Gbps 。非易失性内存快速通道（NVMe）接口是为更好支持SSD开发的逻辑接口标准，常与PCIe接口配合使用。 
- **存储区域网络（SAN）**：磁盘可远程连接，在SAN架构中，大量磁盘通过高速网络连接到多个服务器计算机，通常使用独立磁盘冗余阵列（RAID）技术本地组织磁盘，提供大且可靠的逻辑磁盘视图。互连技术包括iSCSI（允许SCSI命令通过IP网络发送）、光纤通道FC（传输速率1.6 - 12GB/s ）、InfiniBand（低延迟高带宽网络通信）。 
- **网络附加存储（NAS）**：与SAN类似，但提供文件系统接口，使用NFS或CIFS等网络文件系统协议。 
- **云存储（Cloud storage）**：数据存储在云端，通过API访问。若数据与数据库不在同一位置，延迟高，不太适合作为数据库底层存储，但常用于存储对象。 

### 12.3 磁盘（Magnetic Disks）
#### 12.3.1 磁盘物理特性（Physical Characteristics of Disks）
- **盘片与读写头**：磁盘盘片（platter）两面都有读写头，读写头在盘片上移动以访问不同磁道（track）。多个盘片的读写头安装在一个磁盘臂（disk arm）上一起移动。盘片和读写头组成磁头 - 磁盘组件（head - disk assemblies）。所有盘片的第 *i* 磁道合称为第 *i* 柱面（cylinder） 。读写头尽可能靠近盘片表面以提高记录密度，一般仅微米距离，盘片旋转产生的气流使读写头悬浮在盘片表面上方。
- **磁头碰撞问题**：磁头碰撞（head crashes）可能损坏磁盘数据，旧磁盘中磁头接触盘片表面会刮掉记录介质，导致多个磁头和盘片故障。现代磁盘使用磁性金属薄膜作为记录介质，不易导致整个磁盘故障，但易出现个别扇区故障。 
- **磁盘控制器**：磁盘控制器（disk controller）连接计算机系统和磁盘硬件，接受读写扇区的高级命令，移动磁盘臂到正确磁道并读写数据。它会为每个写入扇区附加校验和（checksums），读取时重新计算校验和并对比，若数据损坏且新计算校验和与存储校验和不匹配，会多次重试读取，若仍出错则发出读取失败信号。磁盘控制器还负责重映射坏扇区（remapping of bad sectors） ，检测到扇区损坏时，将其逻辑映射到备用扇区（从预留的额外扇区池中分配），并在磁盘或非易失性内存中记录重映射信息，在新位置执行写入操作。 

#### 12.3.2 磁盘性能指标（Performance Measures of Disks）
- **访问时间（Access time）**：从发出读写请求到数据传输开始的时间，由寻道时间（seek time）和旋转延迟时间（rotational latency time）组成。寻道时间是磁盘臂移动到正确磁道的时间，一般为2 - 20毫秒，平均寻道时间约为最大寻道时间的一半，当前平均寻道时间在4 - 10毫秒。旋转延迟时间是等待要访问的扇区转到读写头下方的时间，磁盘转速一般为5400 - 15000转/分钟，平均旋转延迟时间为磁盘半圈旋转时间。平均访问时间一般在5 - 20毫秒 。 
- **数据传输速率（data - transfer rate）**：磁盘读取或存储数据的速率，当前磁盘系统最大传输速率为50 - 200MB/s ，内圈磁道传输速率远低于最大传输速率。 
- **磁盘I/O请求**：磁盘I/O请求通常由文件系统生成，也可由数据库系统直接生成，请求指定磁盘上的块号（block number） ，磁盘块（disk block）是存储分配和检索的逻辑单元，大小一般为4 - 16KB 。数据在磁盘和主存间以块为单位传输。请求模式分为顺序访问（sequential access）和随机访问（random access） ，顺序访问时连续请求相邻块号，随机访问时连续请求的块在磁盘上随机分布。每秒I/O操作数（IOPS）取决于访问时间、块大小和磁盘数据传输速率，4KB块大小的现代磁盘IOPS在50 - 200 。 
- **平均故障间隔时间（MTTF）**：衡量磁盘可靠性的指标，指磁盘平均连续无故障运行时间，厂商宣称现代磁盘MTTF在500,000 - 1,200,000小时（约57 - 136年 ），实际新磁盘故障概率计算的MTTF约为1,200小时，多数磁盘预期寿命约5年，使用几年后故障率显著增加。 

### 12.4 闪存（Flash Memory）
- **闪存类型**：闪存分为NOR闪存和NAND闪存，NAND闪存主要用于数据存储。从NAND闪存读取数据需将一整页（page ，一般为4096字节）数据读入主存，NAND闪存中的页类似于磁盘中的扇区。 
- **固态硬盘（SSD）特性**：SSD基于NAND闪存，提供与磁盘存储相同的块接口。相比磁盘，SSD随机访问更快，检索一页数据延迟为20 - 100微秒（磁盘随机访问需5 - 10毫秒 ），数据传输速率更高，受互连技术限制，SATA接口约500MB/s ，NVMe PCIe接口可达3GB/s ，功耗显著低于磁盘。 
- **闪存写入操作**：向闪存写入数据较复杂，写入一页闪存通常需约100微秒，且写入后不能直接覆盖，需先擦除再重写。擦除操作针对一组页（擦除块，erase block ，一般256KB - 1MB ，包含128 - 256页 ）进行，约需2 - 5毫秒。闪存页有擦除次数限制，一般为100,000 - 1,000,000次，达到限制后存储位易出错。 
- **闪存管理机制**：闪存系统通过逻辑页号到物理页号的映射，限制擦除速度慢和更新限制的影响。更新逻辑页时，可重映射到已擦除的物理页，原位置稍后擦除。每个物理页有存储逻辑地址的小区域，逻辑地址重映射时原物理页标记为删除，通过扫描物理页可找到逻辑页残留。逻辑 - 物理页映射复制到内存中的转换表（translation table）以便快速访问。包含多个已删除页的块定期擦除，先将未删除页复制到其他块并更新转换表。闪存控制器通过磨损均衡（wear leveling）技术均匀分配擦除操作，将擦除多次的物理页分配给很少更新的“冷数据”，未擦除多次的页存储频繁更新的“热数据”。若物理页因更新次数过多损坏，可从使用中移除而不影响整个闪存。 
- **闪存转换层（flash translation layer）**：上述操作由闪存转换层软件执行，在这一层之上，闪存存储与磁盘存储外观相同，提供相同的页/扇区接口，只是闪存更快，文件系统和数据库存储结构对底层存储结构的逻辑视图相同，无论底层是闪存还是磁盘存储。 

### 附注12.1 存储级内存（Note 12.1 STORAGE CLASS MEMORY）
闪存是最广泛使用的非易失性内存，但多年来也开发了一些替代非易失性内存技术，部分技术允许直接按字节或字读写，避免以页为单位读写及NAND闪存的擦除开销，这类非易失性内存称为存储级内存（storage class memory） 。英特尔和镁光开发的3D - XPoint内存技术是一种存储级内存技术，在每字节成本、访问延迟和容量方面介于主存和闪存之间。基于3D - XPoint的英特尔傲腾SSD于2017年开始出货，傲腾持久内存模块于2018年发布。   

### 12.5 独立磁盘冗余阵列（RAID）
一些应用（如网页、数据库和多媒体应用 ）的数据存储需求增长迅速，尽管磁盘容量不断增大，仍需大量磁盘存储数据。系统中使用大量磁盘时，若并行操作磁盘，可提高数据读写速率，还能通过在多个磁盘上存储冗余信息提高数据存储可靠性，避免单盘故障导致数据丢失。为此提出多种磁盘组织技术，统称为RAID。过去，系统设计者将多个小容量廉价磁盘组成的存储系统视为大容量昂贵磁盘的经济替代方案，但如今RAID系统主要用于提高可靠性和性能，而非出于经济原因，同时也便于管理和操作。

#### 12.5.1 通过冗余提高可靠性（Improvement of Reliability via Redundancy）
一组 *N* 个磁盘中至少有一个磁盘故障的概率远高于单个特定磁盘故障的概率。例如，若单个磁盘平均故障间隔时间（MTTF）为100,000小时（约11年多 ），100个磁盘组成的阵列中某个磁盘的平均故障间隔时间将降至100,000 / 100 = 1000小时（约42天 ），若只存储一份数据，每次磁盘故障都会导致大量数据丢失，这种高数据丢失频率不可接受。

解决可靠性问题的方法是引入冗余（redundancy） ，即存储平时不需要但在磁盘故障时可用于重建丢失信息的额外信息。这样即使磁盘故障，数据也不会丢失，有效提高了平均故障间隔时间（仅计算导致数据丢失或不可用的故障 ）。

引入冗余最简单（但成本最高 ）的方法是镜像（mirroring ，有时也称shadowing） ，即每个磁盘都有一个副本，逻辑磁盘由两个物理磁盘组成，每次写入操作都在两个磁盘上执行。若其中一个磁盘故障，可从另一个磁盘读取数据，只有在第一个故障磁盘修复前第二个磁盘也发生故障时才会丢失数据。

镜像磁盘的平均故障间隔时间（指数据丢失的故障 ）取决于单个磁盘的平均故障间隔时间以及平均修复时间（mean time to repair ，即更换故障磁盘并恢复数据的平均时间 ）。假设两个磁盘故障相互独立，单个磁盘平均故障间隔时间为100,000小时，平均修复时间为10小时，则镜像磁盘系统的数据丢失平均故障间隔时间为100,000² / (2 * 10) = 500 * 10⁶小时（约57,000年 ）。但实际中磁盘故障并非完全独立，电源故障、自然灾害等可能同时损坏两个磁盘，且磁盘老化会增加故障概率。即便如此，镜像磁盘系统仍比单磁盘系统可靠性高得多，如今镜像磁盘系统的数据丢失平均故障间隔时间约为500,000 - 1,000,000小时（55 - 110年 ）。

电源故障是特别需要关注的问题，因为其发生频率远高于自然灾害。若电源故障发生时没有数据传输到磁盘，则无需担心；但即使采用磁盘镜像，若两个磁盘同时写入同一数据块且在电源故障前数据未完全写入，可能导致两个数据块不一致。解决方法是先写入一个副本，再写入另一个副本，确保总有一个副本一致。电源故障后重启时，需采取额外操作从不完全写入中恢复数据。 

#### 12.5.2 通过并行提高性能（Improvement in Performance via Parallelism）
- **磁盘镜像提高读请求处理速率**：磁盘镜像可使读请求处理速率翻倍，因为读请求可发送到任意一个磁盘（只要一对磁盘都正常工作 ），每次读取的传输速率与单磁盘系统相同，但单位时间内读取次数翻倍。 
- **数据条带化（striping）**：使用多个磁盘时，还可通过数据条带化提高传输速率。最简单的数据条带化形式是位级条带化（bit-level striping） ，即将每个字节的位分散存储在多个磁盘上。例如，在由八个磁盘组成的阵列中，将每个字节的第 *i* 位写入磁盘 *i* 。在这种组织方式下，每个磁盘都参与每次访问（读写 ），每秒可处理的访问次数与单磁盘系统大致相同，但每次访问在相同时间内可读取的数据量是单磁盘系统的八倍。 
- **块级条带化（block-level striping）**：将块分散存储在多个磁盘上，把磁盘阵列视为单个大磁盘并为块分配逻辑编号。对于由 *n* 个磁盘组成的阵列，块级条带化将磁盘阵列的逻辑块 *i* 分配给磁盘 (i mod n) + 1 ，并使用该磁盘的第 ⌊i/n⌋ 个物理块存储逻辑块 *i* 。例如，在八个磁盘的阵列中，逻辑块0存储在磁盘1的物理块0中，逻辑块11存储在磁盘4的物理块1中。读取大文件时，块级条带化可同时从 *n* 个磁盘并行获取 *n* 个块，提高大文件读取的数据传输速率；读取单个块时，数据传输速率与单磁盘相同，但其余 *n - 1* 个磁盘可执行其他操作。与位级条带化相比，块级条带化每秒可支持更多块读取，单个块读取延迟更低，因此实际系统中不使用位级条带化。 

磁盘系统中并行的两个主要目标：
1. 对多个小访问（块访问 ）进行负载均衡，提高此类访问的吞吐量。
2. 并行化大访问，降低大访问的响应时间。

>日期：5.8  

#### 12.5.3 RAID级别（RAID Levels）
镜像可提供高可靠性但成本高，条带化可提供高数据传输速率但不提高可靠性。各种替代方案旨在通过结合磁盘条带化和“奇偶校验块”以较低成本提供冗余。

在RAID系统中，块被划分为多个集合，针对给定的块集合，可计算并在磁盘上存储一个奇偶校验块（parity block ），奇偶校验块的第 *i* 位是集合中所有块第 *i* 位的“异或”（XOR）运算结果。若集合中任何一个块因故障丢失内容，可通过计算集合中其余块的按位异或以及奇偶校验块来恢复该块内容。每次写入块时，都必须重新计算并写入其所属集合的奇偶校验块。新的奇偶校验块值可通过以下两种方式计算：（i）从磁盘读取集合中所有其他块并计算新的奇偶校验块；（ii）通过计算奇偶校验块的旧值与更新块的旧值和新值的异或。

这些方案具有不同的成本 - 性能权衡，可分为不同的RAID级别，实际中常用的四个级别如下：
- **RAID 0级**：指块级条带化但无任何冗余（如镜像或奇偶校验位 ）的磁盘阵列，图12.4a展示了大小为4的阵列。 
- **RAID 1级**：指带块条带化的磁盘镜像，图12.4b展示了存储相当于四个磁盘数据的镜像组织。一些厂商用RAID 1+0级或RAID 10级表示带条带化的镜像，用RAID 1级表示不带条带化的镜像。不带条带化的镜像也可用于磁盘阵列，使多个磁盘看起来像一个大容量可靠磁盘，例如每个磁盘有 *M* 个块，逻辑块0到 *M - 1* 存储在磁盘0上， *M* 到 *2M - 1* 存储在磁盘1上，依此类推，且每个磁盘都有镜像。 
- **RAID 5级**：指块交错分布式奇偶校验，数据和奇偶校验在所有 *N + 1* 个磁盘上分区。对于每组 *N* 个逻辑块，其中一个磁盘存储奇偶校验，其他 *N* 个磁盘存储数据块，不同组的 *N* 个块的奇偶校验块存储在不同磁盘上，因此所有磁盘都可参与满足读请求。图12.4c展示了这种设置，P表示奇偶校验块。例如，在五个磁盘的阵列中，逻辑块4k, 4k + 1, 4k + 2, 4k + 3的奇偶校验块Pk存储在磁盘k mod 5上，其他四个磁盘存储相应的数据块4k到4k + 3 。需注意，奇偶校验块不能存储同一磁盘中块的奇偶校验，否则磁盘故障将导致数据和奇偶校验同时丢失，无法恢复。 
- **RAID 6级**：即P + Q冗余方案，与RAID 5级类似，但存储额外冗余信息以应对多个磁盘故障，不使用奇偶校验，而是使用纠错码（如里德 - 所罗门码 ）。在图12.4g的方案中，每四个数据位存储两位冗余数据（与RAID 5级的一位奇偶校验位不同 ），系统可容忍两个磁盘故障。图中字母P和Q表示给定数据块集合对应的两个纠错块，块布局是RAID 5的扩展。例如，在六个磁盘的阵列中，逻辑块4k, 4k + 1, 4k + 2, 4k + 3的两个奇偶校验块Pk和Qk分别存储在磁盘k mod 6和(k + 1) mod 6上，其他四个磁盘存储相应的数据块4k到4k + 3 。

此外，还提出了对基本RAID方案的多种变体，不同厂商对变体使用不同术语。一些厂商支持嵌套方案，即创建多个独立的RAID阵列，然后在这些阵列上条带化数据，单个阵列可选择RAID 1、5或6级。 

#### 12.5.4 硬件问题（Hardware Issues）
RAID可仅通过软件修改在硬件层面无任何改变的情况下实现，这种实现方式称为软件RAID。但构建支持RAID的专用硬件也有显著优势，称为硬件RAID系统。

同时介绍了SSD性能指标相关内容：
1. **每秒随机块读取次数**：以4KB块为标准，2018年典型值约为每秒10,000次随机读取（即10,000 IOPS ），部分型号支持更高速率。与磁盘不同，SSD可并行支持多个随机请求，常见支持32个并行请求。SATA接口的闪存盘通过32个并行请求每秒可支持近100,000次随机4KB块读取，NVMe PCIe接口的SSD每秒可支持超过350,000次随机4KB块读取。这些数值表示为QD-1（无并行 ）和QD-n（n路并行 ），QD-32最常用。 
2. **顺序读和顺序写的数据传输速率**：SATA 3接口的SSD顺序读和顺序写的典型速率为400 - 500MB/s ，使用PCIe 3.0x4接口的NVMe SSD速率为2 - 3GB/s 。 
3. **每秒随机块写入次数**：以4KB块为标准，2018年QD-1（无并行 ）的典型值约为每秒40,000次随机4KB块写入，QD-32约为100,000 IOPS ，部分型号对QD-1和QD-32支持更高速率。 

混合磁盘驱动器（Hybrid disk drives）是将磁性存储与少量闪存结合的硬盘系统，闪存用作频繁访问数据的缓存，很少更新的频繁访问数据适合缓存在闪存中。   

### 12.5.4 硬件问题（Hardware Issues）
- **热插拔（hot swapping）**：服务器硬件常设计为支持热插拔，即无需断电就能移除故障磁盘并更换新磁盘。RAID控制器可检测到磁盘更换，并立即重建旧磁盘上的数据并写入新磁盘。热插拔减少了平均修复时间，因为无需等待系统关机即可更换磁盘。许多关键系统需7×24小时不间断运行，没有时间关机更换故障磁盘。此外，许多RAID实现会为每个阵列（或一组磁盘阵列）分配一个备用磁盘，磁盘故障时可立即使用备用磁盘替换，大大减少平均修复时间，降低数据丢失风险，故障磁盘可随后从容更换。 
- **避免单点故障**：RAID系统中电源、磁盘控制器或系统互连可能成为单点故障，导致RAID系统停止运行。为避免这种情况，良好的RAID实现会配备多个冗余电源（带有电池备份，即使断电也能继续工作 ），拥有多个磁盘接口和多个连接，将RAID系统连接到计算机系统（或计算机系统网络 ），这样单个组件故障不会导致RAID系统停止运行。 

### 12.5.5 RAID级别的选择（Choice of RAID Level）
选择RAID级别时需考虑以下因素：
- **额外磁盘存储需求的成本**：包括购买额外磁盘的费用等。
- **每秒I/O操作次数的性能要求**：不同RAID级别对I/O操作的支持能力不同。
- **磁盘故障时的性能**：如数据丢失风险、系统降级运行的表现等。
- **重建期间的性能（即故障磁盘数据在新磁盘上重建时的性能 ）**：不同RAID级别重建数据的难度和时间不同，RAID 1级重建最容易，可直接从另一个磁盘复制数据；其他级别需访问阵列中所有其他磁盘来重建故障磁盘数据。在要求数据持续可用的高性能数据库系统中，RAID系统的重建性能是重要因素，且重建时间占修复时间比例较大，会影响数据丢失的平均时间。 

不同RAID级别的应用场景和特点：
- **RAID 0级**：在对数据安全要求不高的少数高性能应用中使用，因为它无冗余，数据安全性低。 
- **RAID 1级**：在数据库系统中存储日志文件等应用场景较受欢迎，因为它提供最佳的写入性能。与RAID 5级相比，其存储开销更高，但写入时间开销更低。对于存储需求适中且随机I/O要求高的应用，RAID 1级是不错的选择。 
- **RAID 5级**：存储开销比RAID 1级低，但写入时间开销更高。对于数据频繁读取、很少写入的应用，RAID 5级是首选。不过，它对随机写入有显著开销，单个随机块写入需2次块读取（获取块和奇偶校验块的旧值 ）和2次块写入（写回这些块 ）；但对大型顺序写入开销较低，因为多数情况下可从新块计算奇偶校验块，无需读取。 
- **RAID 6级**：比RAID 1级和5级可靠性更高，能容忍两个磁盘故障而不丢失数据。正常运行时性能与RAID 5级类似，但存储成本更高。在数据安全非常重要的应用中使用，由于潜在扇区故障并不少见，且可能需要很长时间才能检测和修复，在检测和修复潜在故障前另一个磁盘故障，对于RAID 1级和5级可能导致数据丢失，而RAID 6级可避免。 
- **镜像扩展**：镜像也可扩展为在三个磁盘上存储副本（而非两个 ）以应对两个磁盘故障，这种三重冗余方案在RAID系统中不常见，但在分布式文件系统中使用，因为机器故障概率比磁盘故障概率高得多。 

RAID系统设计时还需做其他决策，如阵列中磁盘数量（磁盘数量多，数据传输速率高，但系统成本高 ）、每个奇偶校验位保护的位数（奇偶校验位保护位数多，奇偶校验位导致的空间开销低，但第一个故障磁盘修复前第二个磁盘故障导致数据丢失的风险增加 ）。 

### 软件RAID与硬件RAID对比
- **硬件RAID**：可使用非易失性RAM记录写入操作，断电后系统重启时，从非易失性RAM检索未完成写入的信息并完成写入，然后恢复正常操作。 
- **软件RAID**：在断电后可能需要额外工作来恢复数据。对于RAID 1级，需扫描磁盘上的所有块，查看两个磁盘上的块对内容是否不同；对于RAID 5级，需扫描磁盘，为每组块重新计算奇偶校验并与存储的奇偶校验比较。这些扫描耗时，且在后台使用磁盘可用带宽的一小部分进行。硬件RAID没有软件RAID在重新同步阶段的限制，重新同步阶段允许正常读写，但此时磁盘故障可能导致未完成写入的块数据丢失。 

### 潜在故障与应对措施
即使所有写入正常完成，磁盘上的扇区仍可能在某个时间点变得无法读取，原因包括制造缺陷、相邻磁道重复写入导致数据损坏等，这种早期成功写入的数据丢失有时称为潜在故障（latent failure）或位衰减（bit rot）。若早期检测到故障，可从RAID组织中的其余磁盘恢复数据；若未检测到，另一个磁盘出现故障时，单个磁盘故障可能导致数据丢失。为最小化数据丢失风险，良好的RAID控制器会执行磁盘扫描（scrubbing ），即在磁盘空闲时读取每个磁盘的每个扇区，若发现不可读扇区，从RAID组织中的其余磁盘恢复数据并写回（若物理扇区损坏，磁盘控制器会将逻辑扇区地址重映射到不同的物理扇区 ）。   

### 12.5.6 其他RAID应用（Other RAID Applications）
RAID的概念已推广到其他存储设备：
- **SSD中的闪存设备**：单个闪存页的数据丢失率比磁盘扇区高，SSD等闪存设备内部实现RAID，以确保不会因闪存页丢失而丢失数据。 
- **磁带阵列**：即使磁带阵列中的一个磁带损坏，RAID结构也能恢复数据。 
- **数据广播**：将数据块分割成短单元并与奇偶校验单元一起广播，若因任何原因未接收到某个单元，可从其他单元重建。 

### 12.6 磁盘块访问（Disk-Block Access）
- **访问模式**：磁盘I/O请求由数据库系统生成，查询处理子系统负责大部分磁盘I/O。请求指定磁盘标识符和磁盘上的逻辑块号。磁盘块请求序列可分为顺序访问模式和随机访问模式。顺序访问模式下，连续请求的块号连续，位于同一磁道或相邻磁道；随机访问模式下，连续请求的块在磁盘上随机分布，每次请求都需寻道，导致访问时间更长，每秒随机I/O操作次数更低。 
- **优化技术**：为提高磁盘块访问速度，减少访问次数尤其是随机访问次数，开发了以下技术：
    - **缓冲（Buffering）**：从磁盘读取的块临时存储在内存缓冲区中，以满足未来请求。操作系统和数据库系统都会进行缓冲，数据库缓冲在13.5节详细讨论。 
    - **预读（Read-ahead）**：访问磁盘块时，即使没有对后续块的挂起请求，也将同一磁道的连续块读入内存缓冲区。对于顺序访问，预读可确保请求块时许多块已在内存中，减少每次读块时磁盘寻道和旋转延迟浪费的时间。操作系统也会对操作系统文件的连续块进行预读，但预读对随机块访问作用不大。 
    - **调度（Scheduling）**：若要将一个柱面的多个块从磁盘传输到主存，按块通过磁头的顺序请求可节省访问时间；若所需块位于不同柱面，按最小化磁盘臂移动的顺序请求块有利。磁盘臂调度算法（如电梯算法，elevator algorithm ）尝试对磁道访问进行排序，以增加可处理的访问次数。初始时磁盘臂从最内圈磁道向外移动，在电梯算法控制下，遇到有访问请求的磁道时，磁盘臂停止服务该磁道请求，然后继续向外移动，直到没有更外圈磁道的等待请求，此时磁盘臂改变方向向内移动，同样在有请求的磁道停止，直到到达没有更内圈磁道请求的磁道，然后反转方向开始新周期。磁盘控制器通常会重新排序读请求以提高性能，因为其清楚磁盘上块的组织、磁盘盘片旋转位置和磁盘臂位置。为实现重新排序，磁盘控制器接口需允许多个请求添加到队列，结果可与请求顺序不同返回。 
    - **文件组织（File organization）**：为减少块访问时间，可按预期数据访问方式组织磁盘上的块。例如，预期文件顺序访问，应将文件的所有块顺序存储在相邻柱面。现代磁盘对操作系统隐藏实际块位置，使用逻辑编号为相邻块分配连续编号，操作系统允许文件的连续块按顺序编号存储以确保顺序存储。将大文件存储为单个长连续块序列对磁盘块分配有挑战，操作系统每次为文件分配一定数量连续块（称为盘区，extent ），分配给文件的不同盘区在磁盘上可能不相邻。顺序访问文件时，每个盘区需一次寻道，盘区足够大时，寻道成本相对数据传输成本可最小化。随时间推移，多次小追加的顺序文件可能碎片化（fragmented ），即块分散在磁盘各处。为减少碎片化，系统可备份磁盘数据并恢复整个磁盘，恢复操作将每个文件的块连续（或接近连续 ）写回。一些系统（如不同版本的Windows操作系统 ）有扫描磁盘并移动块以减少碎片化的实用程序。 
    - **非易失性写缓冲区（Non-volatile write buffers）**：由于主存内容断电丢失，数据库更新信息需记录在磁盘以应对系统崩溃，因此更新密集型数据库应用（如事务处理系统 ）的性能很大程度依赖磁盘写入延迟。可使用非易失性随机访问存储器（NVRAM）加速磁盘写入，NVRAM内容断电不丢失。早期用带电池备份的RAM实现NVRAM，现在闪存是主要非易失性写缓冲介质。数据库系统（或操作系统）请求将块写入磁盘时，磁盘控制器将块写入非易失性写缓冲区并立即通知操作系统写入成功，随后控制器可按最小化磁盘臂移动的方式（如使用电梯算法 ）将数据写入磁盘目标位置。若不使用非易失性写缓冲区进行写重新排序，系统崩溃时数据库状态可能不一致，第19章的恢复算法依赖按指定顺序写入。数据库系统请求块写入时，仅当NVRAM缓冲区满时才会注意到延迟。系统崩溃恢复时，NVRAM中挂起的缓冲写入会写回磁盘。NVRAM缓冲区在某些高端磁盘中存在，在RAID控制器中更常见。 

除上述低级优化外，还可通过巧妙设计查询处理算法在更高级别最小化随机访问，第15章将研究高效查询处理技术。 

### 12.7 总结（Summary）
- **数据存储类型**：大多数计算机系统存在多种数据存储类型，按数据访问速度、单位数据购买成本和可靠性分类，包括高速缓存、主存、闪存、磁盘、光盘和磁带等。 
- **磁盘特性**：磁盘是机械设备，数据访问需读写头移动到所需柱面，盘片旋转使所需扇区移到读写头下，数据访问延迟高。 
- **SSD特性**：SSD数据访问延迟远低于磁盘，数据传输带宽更高，但每字节成本高于磁盘。 
- **数据可靠性**：磁盘易发生故障导致数据丢失，保留数据多个副本可降低不可恢复数据丢失的可能性。 
- **RAID优势**：镜像大大降低数据丢失概率，基于RAID的更复杂方法通过磁盘条带化提高大访问吞吐量，通过引入冗余提高可靠性。 
- **RAID级别**：存在多种RAID组织，各有不同成本、性能和可靠性特征，RAID 1级（镜像）和RAID 5级最常用。 
- **磁盘块访问优化**：开发了预读、缓冲、磁盘臂调度、文件组织和非易失性写缓冲区等技术优化磁盘块访问。

>日期：5.10  

### 课后习题选做
### 习题解答
#### 12.8
常见物理存储介质及其数据访问速度：
- **高速缓存（Cache）**：访问速度极快，通常在纳秒（ns）级别。它是位于CPU和主存之间的高速存储，用于存储CPU近期可能会频繁访问的数据和指令，能让CPU快速获取数据，减少等待时间。 
- **主存（Main Memory，如DDR内存 ）**：访问速度较快，一般在几十纳秒，例如DDR4内存的访问延迟大约在60 - 70ns左右。主存用于存储计算机正在运行的程序和数据，CPU可直接对其进行读写操作。 
- **固态硬盘（SSD）**：访问速度较快，随机读取延迟一般在几十到几百微秒（μs） ，顺序读取速度可达数百MB/s甚至更高。例如，SATA接口的SSD顺序读取速度可达500 - 550MB/s ，NVMe接口的SSD顺序读取速度可超过3GB/s 。它采用闪存芯片作为存储介质，相比传统机械磁盘，没有机械寻道等延迟。 
- **机械磁盘（Magnetic Disk）**：访问速度较慢，随机访问延迟通常在毫秒（ms）级别，例如5 - 10ms ，顺序读取速度一般在几十MB/s到上百MB/s 。机械磁盘通过磁头在高速旋转的盘片上进行数据的读写操作，磁头寻道和盘片旋转会带来较大延迟。 
- **磁带（Magnetic Tape）**：访问速度慢，通常用于数据的长期归档存储。顺序访问速度相对还可以，但随机访问速度极慢，因为需要机械地卷动磁带寻找数据位置，可能需要数秒甚至更长时间。 
- **光盘（Optical Disk，如CD、DVD、BD ）**：访问速度较慢，读取速度因类型而异，例如CD读取速度一般在1 - 2MB/s ，DVD读取速度一般在5 - 10MB/s ，蓝光光盘（BD）读取速度可达到20 - 50MB/s左右。光盘通过激光读取存储在盘片上的数据。 

#### 12.9
磁盘控制器对坏扇区的重映射（remapping of bad sectors）对数据检索速率的影响：
- **短期影响**：当磁盘控制器检测到坏扇区并进行重映射时，在重映射的瞬间，可能会有短暂的延迟。这是因为控制器需要执行逻辑映射操作，将对坏扇区的访问重新定向到备用扇区（从预留的额外扇区池中分配 ），并在磁盘或非易失性内存中记录重映射信息。不过这个延迟通常相对较小，对于整体数据检索速率影响不大。 
- **长期影响**：如果磁盘存在较多坏扇区且频繁进行重映射，可能会对数据检索速率产生一定影响。一方面，磁盘上的备用扇区数量有限，如果坏扇区过多，可能会逐渐耗尽备用扇区资源，导致后续无法有效重映射，进而影响数据存储和检索。另一方面，频繁重映射可能会使磁盘上的数据分布变得更加分散，在进行顺序读取等操作时，可能会增加磁盘寻道时间（对于机械磁盘 ）或增加内部管理开销（对于SSD ），从而降低数据检索速率。但如果磁盘控制器管理得当，通过合理的算法和缓存机制等，可在一定程度上缓解这种负面影响。 

#### 12.10
**对于机械磁盘**：操作系统尽量确保文件的连续块存储在连续的磁盘块上非常重要，原因如下：
- **减少寻道时间**：机械磁盘通过磁头在盘片上寻道来定位数据。如果文件的连续块分散存储，磁头需要频繁移动到不同磁道，每次寻道都需要一定时间，这会显著增加数据读取时间。而连续存储时，磁头在读取完一个块后，只需等待盘片旋转到下一个连续块位置即可读取，大大减少了寻道时间，提高了数据读取效率。 
- **提高顺序读取性能**：许多应用场景下，文件是按顺序访问的，如读取文本文件、视频文件等。文件连续块连续存储时，顺序读取能充分利用机械磁盘的特性，以较高速度读取数据，提升整体性能。 

**对于SSD**：
- **随机访问优势**：SSD没有机械寻道过程，其内部的闪存芯片可直接进行数据的读写操作，随机访问性能远优于机械磁盘。即使文件块不连续存储，SSD也能快速定位并读取不同位置的块，所以文件连续块是否连续存储对其性能影响相对较小。 
- **内部管理机制**：SSD有自己的闪存转换层（flash translation layer）来管理逻辑地址到物理地址的映射，会对数据存储进行优化。例如，通过磨损均衡（wear leveling）技术均匀分配擦除操作，以及对垃圾回收等操作进行管理，使得文件块的物理存储位置对性能的影响不像机械磁盘那么关键。但在一些情况下，连续存储仍可能带来一定好处，比如减少闪存转换层的映射管理开销等，只是相比机械磁盘，重要性降低。 

#### 12.11
在RAID系统中，RAID 1级在故障磁盘数据重建和正在进行的磁盘访问之间产生的干扰最少。原因如下：
- **数据重建原理**：RAID 1级是磁盘镜像，逻辑磁盘由两个物理磁盘组成，数据同时写入两个磁盘。当一个磁盘故障并更换新磁盘后，重建数据时只需从另一个正常磁盘直接复制数据到新磁盘即可。 
- **对现有访问干扰小**：在重建过程中，正在进行的磁盘读访问可以从正常磁盘读取数据，不受重建操作影响；对于写访问，虽然可能会有一定的I/O资源竞争，但相比其他RAID级别，其数据复制操作相对简单直接，不需要像RAID 5、6级那样进行复杂的奇偶校验计算等操作。而RAID 5级重建数据时需要读取多个磁盘上的数据来计算奇偶校验并恢复故障磁盘数据，RAID 6级更复杂，要处理额外的冗余信息来应对双磁盘故障，这些操作都会占用更多磁盘I/O资源，对正在进行的磁盘访问干扰更大。 

#### 12.12
**scrubbing（磁盘扫描）**：在RAID系统中，scrubbing是指在磁盘空闲时，对每个磁盘的每个扇区进行读取操作。如果发现某个扇区不可读，就从RAID组织中的其余磁盘恢复数据，并将恢复后的数据写回该扇区。如果物理扇区损坏，磁盘控制器会将逻辑扇区地址重映射到不同的物理扇区。 

**重要性**：
- **预防潜在故障**：即使所有写入正常完成，磁盘上的扇区仍可能因制造缺陷、相邻磁道重复写入导致数据损坏等原因，在某个时间点变得无法读取，这种早期成功写入的数据丢失有时称为潜在故障（latent failure）或位衰减（bit rot）。通过scrubbing可以早期检测到这些潜在故障，及时恢复数据，避免数据丢失。 
- **提高数据可靠性**：RAID系统通过冗余来提高数据可靠性，但如果某个扇区出现故障且未被及时发现，当另一个磁盘出现故障时，单个磁盘故障可能就会导致数据丢失。scrubbing可有效降低这种风险，确保数据的完整性和可用性，增强整个RAID系统的可靠性。 

#### 12.13
对于不允许在磁盘故障时丢失数据且写密集型的应用，可采用以下存储方式：
- **选择RAID 1级**：RAID 1级是磁盘镜像，每次写入操作都同时在两个磁盘上执行，提供了很高的数据安全性，即使一个磁盘故障，数据也不会丢失。而且它的写入性能较好，适合写密集型应用。虽然存储开销相对较高，但能满足数据不丢失和频繁写入的需求。 
- **结合非易失性写缓冲区（Non-volatile write buffers）**：使用非易失性随机访问存储器（NVRAM）作为写缓冲区。当数据库系统（或操作系统）请求将块写入磁盘时，磁盘控制器先将块写入NVRAM缓冲区并立即通知操作系统写入成功，随后再按优化方式将数据写入磁盘目标位置。这样可以减少磁盘写入延迟，提升写密集型应用的性能，同时NVRAM断电不丢失数据的特性也能保证数据的安全性。 
- **考虑SSD作为存储介质**：SSD相比传统机械磁盘，具有更快的随机访问速度和更高的数据传输带宽，在写密集型场景下能提供更好的性能表现。并且一些SSD内部也实现了RAID等技术来保障数据可靠性，与外部RAID 1级结合使用，可进一步提升数据安全性和存储性能。 


